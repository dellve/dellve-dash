<!-- Component Control-->
<script>
// 1. Setup Poll handler for benchmark progress updates
$request = new PollRequest();

// Use progress proxy to access cross origin resource
function PollRequest() {
  this.pollTimer = null;
  this.interval = 1000; // Request benchmark progress every second
  this.url = '/progress-proxy?url_base={{server}}:{{dellve_port}}';
}

var runDetailStore = {};

var getRunDetail = function(id, key, def) {
  if (id in runDetailStore) {
    return runDetailStore[id][key];
  } else {
    return def;
  }
};

var updateRunDetailOutput = function (id) {
  HTML = '';
  var outputValue = getRunDetail(id, 'output', null);
  if (outputValue != null) {
    for (var n = 0; n < outputValue.length; n++) {
      HTML = HTML + "<p>" + outputValue[n] + "</p>";
    }
  }
  document.getElementById('benchmark-output-container').innerHTML = HTML;
};

var updateRunDetailProgress = function (id) {
  document.getElementById('benchmark-progress').innerHTML = getRunDetail(id, 'progress', '0') + "%";
};

var storeRunDetail = function(runDetail) {
  runDetailStore[runDetail['id']] = runDetail;
};

// Disable long poll when benchmark run inactive ( no need to poll dellve indefinitely )
PollRequest.prototype.deactivatePoll = function () {
  clearInterval(this.pollTimer);
  this.pollTimer = null;
};

// Long poll dellve server for progress updates on currently running benchmark
PollRequest.prototype.activatePoll = function () {
  this.pollTimer = setInterval(() => {
    $.getJSON(this.url, function(runDetail) {
        console.log(runDetail['id']);
        storeRunDetail(runDetail);
        console.log('Benchmark Progress:' + runDetail['progress']);
        $('#benchmark-progress').attr('aria-valuenow', runDetail['progress']).css('width',runDetail['progress'] + "%");
        // Benchmark run complete, end polling, change stop to start button,
        if ( runDetail['progress'] == 100 ) {
            setTimeout($request.deactivatePoll, 2000);
            console.log('Benchmark run complete');
            var controlButton = document.getElementById('benchmark-start-stop');
            controlButton.value = 'Start';
            controlButton.className = 'btn btn-info';
            // TODO: populate benchmark detail
            $('#benchmark-detail').attr('aria-expanded', true); // expand detail panel
            // paint progress bar green to represent finished benchmark state
            document.getElementById('benchmark-progress').className = 'progress-bar progress-bar-success progress-bar-striped';
            document.getElementById('benchmark-progress').innerHTML = "Complete";
        } else {
            updateRunDetailProgress(runDetail['id']);
            updateRunDetailOutput(runDetail['id']);
        }
    })
  }, this.interval);
};

// 2. Initialize proper run panel configuration
// User may have left benchmark page in middle of benchmark run
// if benchmark is still running, restore stop button and proper progress bar value
// elsewise, restore previous benchmark results (if there are any)

{% if run_detail['progress'] != 0 and run_detail['progress'] != 100 %}
$request.activatePoll();
{% endif %}



</script>
<!-- TODO: in above, use state instead of progress flag to allow differentiation
between currently running (active) benchmark and benchmark that was stopped prematurely.
Can also use this flag to toggle colour of progress bar
(yellow stopped, green active/complete {or blue running, green complete, yellow stopped} )  -->

<!-- Component View -->
<!-- TODO: Fix styling;
BEGIN BENCHMARK RUN DETAIL PANEL -->
<div id="accordion2" class='panel panel-default accordion-group' style='width:91%;'>
    <div class='panel-heading' style='height: 55px; position:relative'>
        <a class='accordion-toggle'  data-toggle="collapse"  data-parent="#accordion2" href="#benchmark-detail">
            <div class="row">
                <div class='col-xs-6' style='align: left;'>
                    <h4 class='panel-title'>Run Detail</h4>
                </div>
                <div class='col-xs-6' style='align: right'>
                    <div class="progress">
                        <!-- TODO: initialize progress bar colour with respect to benchmark state
                            TODO: add value and state label-->
                        <div id='benchmark-progress' class="progress-bar progress-bar-info progress-bar-striped"
                            role="progressbar" aria-valuenow="{{ run_detail['progress'] }}"
                            aria-valuemin="0" aria-valuemax="100" style="width:{{ run_detail['progress'] }}%; margin-bottom:-50%; min-width: 2em;"
                            value="{{ run_detail['progress'] }}%"> {{ run_detail['progress'] }} %
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <!-- TODO: Insert Detail panel specs-->
    <div id="benchmark-detail" aria-expanded='false' class="collapse in panel-body">
      <div id="benchmark-output-container" style='width: 100%;'></div>
    </div>
</div>
<!-- END BENCHMARK DETAIL PANEL -->
