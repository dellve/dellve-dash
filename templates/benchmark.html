<!DOCTYPE html>
<html lang="en">
<head>
    <!--TODO: Extract custom CSS to stylesheet -->
    <title>DellVE Dash: Benchmarks</title>
    <meta name="author" content="Abigail Johnson">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website"/>
    <link rel="shortcut icon" href="../static/img/bodybuilder-favicon.png">
    <!--Loading bootstrap css-->
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,300,700">
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Oswald:400,700,300">
    <link type="text/css" rel="stylesheet" href="../static/css/jquery-ui-1.10.4.custom.min.css">
    <link type="text/css" rel="stylesheet" href="../static/css/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="../static/css/main.css">
    <link type="text/css" rel="stylesheet" href="../static/css/style-responsive.css">
    <link type="text/css" rel="stylesheet" href="../static/css/benchmark.css">
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
</head>
<!--   1. Select a theme. (this section has to appear before loading dashboard.js) -->
<script>var netdataTheme = 'slate'; //var netdataTheme = 'default'; </script>
<!--   2.  Load dashboard.js -->
<script type="text/javascript" src="http://{{ server }}:{{ netdata_port }}/dashboard.js"></script>
<!--   3.  Set netdata config options -->
<script type="text/javascript" src="../static/js/netdata-config.js"></script>
<script>
//     4. Setup action handlers for stop/start buttons
function getBenchmarkAction(form) {
    var benchmarkId = document.getElementById('benchmark-container').value;
    var controlButton = document.getElementById('benchmark-start-stop');
    if ( controlButton.value == 'Start') {
        form.action = "http://{{server}}:{{dellve_port}}/benchmark/" + benchmarkId + "/start";
        $('#benchmark-progress').attr('aria-valuenow', 0).css('width', "0%");
        controlButton.value = 'Stop';
        controlButton.className = 'btn btn-warning';
        $request.activatePoll();
    } else {
        form.action = "http://{{server}}:{{dellve_port}}/benchmark/" + benchmarkId + "/stop";
        controlButton.value = 'Start';
        controlButton.className = 'btn btn-info';
        $request.deactivatePoll();
    }
}

// 5. Setup poll handlers for benchmark progress updates
//$(document).ready(function () { $request = new PollRequest(); });
$request = new PollRequest();

function PollRequest() {
  this.pollTimer = null;
  this.interval = 1000; // Request benchmark progress every second
  this.url = '/progress_proxy?url_base={{server}}:{{dellve_port}}';
}

PollRequest.prototype.deactivatePoll = function () {
  clearInterval(this.pollTimer);
  this.pollTimer = null;
};

PollRequest.prototype.activatePoll = function () {
  this.pollTimer = setInterval(() => {
    $.getJSON(this.url, function(runDetail) {
        console.log('Benchmark Progress:' + runDetail['progress']);
        $('#benchmark-progress').attr('aria-valuenow', runDetail['progress']).css('width',runDetail['progress'] + "%");
        // Benchmark run complete, end polling, change stop to start button,
        if ( runDetail['progress'] == 100 ) {
            console.log('Benchmark run complete');
            var controlButton = document.getElementById('benchmark-start-stop');
            controlButton.value = 'Start';
            controlButton.className = 'btn btn-info';
            $request.deactivatePoll();
            $('#benchmark-detail').attr('aria-expanded', true); // expand detail panel
        }
    })
  }, this.interval);
};

// 6. Initialize proper run panel configuration
// User may have left benchmark page in middle of benchmark run
// if benchmark is still running, restore stop button and proper progress bar value
// elsewise, restore previous benchmark results (if there are any)
{% if run_detail['progress'] != 0 and run_detail['progress'] != 100 %}
$request.activatePoll();
{% endif %}
</script>
<body>
    <!-- TODO: Better style this so that it doesn't interfere with UI
    Dummy iframe - target for form submission (prevent GET request to Dellve from opening in current or new window)-->
    <iframe width="0" height="0" border="0" name="dummyframe" id="dummyframe"></iframe>
    {% include 'templates/nav_header.html' %}
    <!-- BEGIN PAGE WRAPPER -->
    <div>
        {% include 'templates/sidebar.html' %}
        <script> document.getElementById('benchmark-page').className = 'active';</script>
        <!-- BEGIN PAGE CONTENT -->
        <div style='margin-left: 300px;'><br>
            {% include 'templates/benchmark-control.html' %}
            {% include 'templates/benchmark-run-detail.html' %}
            {% include 'templates/nvidia_charts.html' %}
        </div>
        <!-- END PAGE CONTENT -->
        <!--CORE JAVASCRIPT-->
        <script src="../static/js/jquery-1.10.2.min.js"></script>
        <script src="../static/js/jquery.menu.js"></script>
        <script src="../static/js/jquery-ui.js"></script>
        <script src="../static/js/bootstrap.min.js"></script>
        <script src="../static/js/responsive-tabs.js"></script>
    </div>
    <!-- END PAGE WRAPPER -->
</body>
</html>
