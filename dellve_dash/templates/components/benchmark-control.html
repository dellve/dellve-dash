<!-- Component Control-->
<script>
//   Action handler for stop/start commands
function getBenchmarkAction(form) {
    // 1. Send start/stop to DellveAPI
    var benchmarkId = document.getElementById('benchmark-container').value;
    var controlButton = document.getElementById('benchmark-start-stop');
    $.ajax({
      type: "POST",
      url: '/tool-action-proxy?b_id=' + benchmarkId + '&url_base={{server}}:{{dellve_port}}&action=' + controlButton.value,
      data: JSON.stringify(configEditor.get()),
      success: function(){},
      dataType: "json",
      contentType : "application/json"
    });
    //2 .Repaint Buttons
    // Benchmark Start

    if ( controlButton.value == 'Start') {
        document.getElementById('run-detail').innerHTML = ''; // clear logs
        $('#benchmark-progress').attr('aria-valuenow', 0).css('width', "0%"); // reset progress
        document.getElementById('benchmark-progress').innerHTML = "0 %";
        controlButton.value = 'Stop';
        controlButton.className = 'btn btn-warning btn-lg';
        document.getElementById('benchmark-progress').className = 'progress-bar progress-bar-info progress-bar-striped';
    // Benchmark stop
    } else {
        controlButton.value = 'Start';
        controlButton.className = 'btn btn-info btn-lg';
        document.getElementById('benchmark-progress').className = 'progress-bar progress-bar-warning progress-bar-striped';
        document.getElementById('benchmark-progress').innerHTML = 'Stopped';
    }
}

// Use long-poll progress proxy to access cross origin resource
function PollRequest() {
  this.pollTimer = null;
  this.interval = 1000; // Request benchmark progress every second
  this.url = '/progress-proxy?url_base={{server}}:{{dellve_port}}';
}

// Long poll dellve server for progress updates on currently running benchmark
PollRequest.prototype.activatePoll = function () {
  this.pollTimer = setInterval(() => {
    $.getJSON(this.url, function(runDetail) {
        // Repaint start/stop, run detail logging, and progress bar on tool run updates
        updateControlPanel(runDetail);
        updateProgressBar(runDetail);
        updateRunDetail(runDetail);
    })
  }, this.interval);
};


/* Helper method to update tool start/stop button and dropdown w/ respect to tool run progress */
function updateControlPanel(runDetail) {
    var activeTool = document.getElementById('benchmark-container');
    var controlButton = document.getElementById('benchmark-start-stop');
    // 1. Init Dropdown to last run on initial page load and init tool config editor
    if (firstCheck == true) {
        firstCheck = false;
        activeTool.value = runDetail['id'];
        updateConfigEditor();
    }
    // 2. Tool Run in Progress
    if ( runDetail['running'] == true  ) {
        activeTool.value = runDetail['id'] // Default dropdown to currently currently running benchmark
        controlButton.className = 'btn btn-warning btn-lg';
        controlButton.value = 'Stop';
    // 3. Tool Run complete or Stopped
    } else {
        controlButton.className = 'btn btn-info btn-lg';
        controlButton.value = 'Start';
    }
}

/* Helper function update progress bar */
function updateProgressBar(runDetail) {
    $('#benchmark-progress').attr('aria-valuenow', runDetail['progress']).css('width',runDetail['progress'] + "%");
    var progressBar = document.getElementById('benchmark-progress');
    // 1. Tool run complete
    if ( runDetail['progress'] == 100 ) {
        progressBar.className = 'progress-bar progress-bar-success progress-bar-striped';
        progressBar.innerHTML = "Complete";
    // 2. Tool run in progress
    } else if ( runDetail['running'] == true ) {
        progressBar.className = 'progress-bar progress-bar-info progress-bar-striped';
        progressBar.innerHTML = runDetail['progress'] + "%";
    // 3. Tool Run stopped
    } else {
        progressBar.className = 'progress-bar progress-bar-warning progress-bar-striped';
        progressBar.innerHTML = 'Stopped';
    }
}

/* Helper method to update Run Detail panel logging and header */
function updateRunDetail(runDetail) {
    // 1. Update Header
    document.getElementById('run-detail-heading').innerHTML = 'Run Detail: ' + runDetail['name'];
    // 2. Update Logging
    var logs = JSON.stringify(runDetail['output']);
    // Remove ANSI codes and misformed literals and styled header
    logs = logs.replace(/['"]+/g, '').replace(/,/g , ' ').replace(/\\n/g, "<br/>").replace(/\\t/g, "&nbsp;").replace(/\\u001b\[0m/g, "&nbsp;").replace(/\\u001b\[0;31m/g, "&nbsp;").substring(1, logs.length-1);
    var header = "";
    if (runDetail['name']!= 'HPL') {
        header = "<p style='text-align:center'>====================================================================================<br><br>";
        header = header += runDetail['name'] += "<br><br>Dellve Deep GPU Stress and Capabilities Tool Suite<br>The University of Texas at Austin ECE<br><br>";
        header =  header += "Quian Baula, Travis Chau, Abigail Johnson, Jayesh Joshi, Konstantyn Komarov<br><br>";
        header = header += "====================================================================================<br><br></p>";
    }
    document.getElementById('run-detail').innerHTML = header += logs;
    // 3. Default scroll to bottom on active tool run
    if ( runDetail['running'] == true ) {
        document.getElementById('run-detail').scrollTop = document.getElementById('run-detail').scrollHeight;
    }
}


/* Helper method repaint tool config editor on dropdown tool change */
function updateConfigEditor() {
    var elem = document.getElementById("benchmark-container");
    var configStr = elem.options[elem.selectedIndex].getAttribute('data-config');
    configStr = configStr.replace(/'/g, '"');
    var updatedConfig = JSON.parse(configStr);
    container = document.getElementById("config-editor");
    container.innerHTML = '';
    configEditor = new JSONEditor(container, {
        mode: 'form',
        name: 'Configuration Data',
        search: false
    });
    configEditor.set(updatedConfig);
    //configEditor.enable();
}

// 1. Setup Poll handler for benchmark progress updates and activate poll
$request = new PollRequest();
$request.activatePoll();
var firstCheck = true;
updateConfigEditor();

</script>

<!-- Component View -->
<!-- BEGIN BENCHMARK RUN CONFIG  -->
<div class='row'>
    <div class='col-lg-12' >
        <div class="col-md-5">
            <br><h1> GPU Stress and Capabilities Tools </h1>
        </div>
        <!-- BEGIN RUN CONFIG FORM -->
        <form onsubmit="getBenchmarkAction(this);" target='dummyframe' >
            <div class= 'form-group'>
                    <div class='col-md-3' >
                        Tool Type
                        <!-- Dynamically populate benchmark dropdown and restore last user-select benchmark
                            create configuration dictionary
                            TODO: validate config json format and ammend as necessary
                        -->
                        <select id='benchmark-container'  class="selectpicker form-control" onchange="updateConfigEditor();">
                                {% for benchmark in benchmarks %}
                              <option value="{{ benchmark['id'] }}" data-config="{{benchmark['config']}}">{{ benchmark['name'] }}</option>
                                {% endfor %}
                        </select>
                    </div>
                    <div class='col-md-3'>
                        {% include 'templates/components/config-editor.html' %}
                    </div>
                    <!-- Toggle Between Start/Stop Button -->
                    <div class='col-md-1'>
                        {% if run_detail['running'] == False -%}
                        <input id='benchmark-start-stop' type="submit" style='width: 100%' class="btn btn-info btn-lg" value='Start'></input>
                        {% else -%}
                        <input id='benchmark-start-stop' type="submit" style='width: 100%' class="btn btn-warning btn-lg" value='Stop'></input>
                        {%- endif %}
                    </div>
            </div>
        </form>
    </div>
</div>
<br>
<!-- END BENCHMARK RUN CONFIG -->
