<!-- Component Control-->
<script>
//   Action handler for stop/start commands
function getBenchmarkAction(form) {
    var benchmarkId = document.getElementById('benchmark-container').value;
    var controlButton = document.getElementById('benchmark-start-stop');
    // Benchmark Start
    if ( controlButton.value == 'Start') {
        // send start command to dellve api
        form.action = "http://{{server}}:{{dellve_port}}/benchmark/" + benchmarkId + "/start";
        $('#benchmark-progress').attr('aria-valuenow', 0).css('width', "0%");
        document.getElementById('benchmark-progress').innerHTML = "0 %";
        // repaint stop button
        controlButton.value = 'Stop';
        controlButton.className = 'btn btn-warning btn-lg';
        document.getElementById('benchmark-progress').className = 'progress-bar progress-bar-info progress-bar-striped';
    // Benchmark stop
    } else {
        // send stop command to dellve api
        form.action = "http://{{server}}:{{dellve_port}}/benchmark/" + benchmarkId + "/stop";
        // repaint start button
        controlButton.value = 'Start';
        controlButton.className = 'btn btn-info btn-lg';
        // paint progress bar yellow for 'stopped' benchmark state
        document.getElementById('benchmark-progress').className = 'progress-bar progress-bar-warning progress-bar-striped';
        document.getElementById('benchmark-progress').innerHTML = 'Stopped';
    }
}


</script>

<script>
// 1. Setup Poll handler for benchmark progress updates
$request = new PollRequest();

// Use progress proxy to access cross origin resource
function PollRequest() {
  this.pollTimer = null;
  this.interval = 1000; // Request benchmark progress every second
  this.url = '/progress-proxy?url_base={{server}}:{{dellve_port}}';
}

// Disable long poll when benchmark run inactive
// Currently not in use
PollRequest.prototype.deactivatePoll = function () {
  clearInterval(this.pollTimer);
  this.pollTimer = null;
};

var firstCheck = true;

// Long poll dellve server for progress updates on currently running benchmark
PollRequest.prototype.activatePoll = function () {
  this.pollTimer = setInterval(() => {
    $.getJSON(this.url, function(runDetail) {
        var controlButton = document.getElementById('benchmark-start-stop');
        // select benchmark dropdown value to currently running/last run benchmark
        // TODO: populate benchmark detail
        document.getElementById('run-detail-heading').innerHTML = 'Run Detail: ' + runDetail['name'];
        document.getElementById('run-detail').innerHTML = runDetail['output'];
        $('#benchmark-progress').attr('aria-valuenow', runDetail['progress']).css('width',runDetail['progress'] + "%");
        // When page first loads, initialze dropdown with last run benchmark
        if (firstCheck == true) {
            firstCheck = false;
            document.getElementById('benchmark-container').value = runDetail['id'];
        }
        if ( runDetail['progress'] == 100 ) {
            controlButton.value = 'Start';
            controlButton.className = 'btn btn-info btn-lg';
            document.getElementById('benchmark-progress').className = 'progress-bar progress-bar-success progress-bar-striped';
            document.getElementById('benchmark-progress').innerHTML = "Complete";
        // TODO: disable stop if user is not benchmark run owner
        } else if ( runDetail['running'] == true ) {
            document.getElementById('benchmark-container').value = runDetail['id'] // Default dropdown to currently currently running benchmark
            document.getElementById('run-detail-heading').innerHTML = 'Run Detail: ' + runDetail['name'];
            document.getElementById('benchmark-progress').innerHTML = runDetail['progress'] + "%";
            controlButton.value = 'Stop';
            controlButton.className = 'btn btn-warning btn-lg';
            document.getElementById('benchmark-progress').className = 'progress-bar progress-bar-info progress-bar-striped';
        // Benchmark stopped
        } else {
            controlButton.value = 'Start';
            controlButton.className = 'btn btn-info btn-lg';
            document.getElementById('benchmark-progress').className = 'progress-bar progress-bar-warning progress-bar-striped';
            document.getElementById('benchmark-progress').innerHTML = 'Stopped';
        }

    })
  }, this.interval);
};

$request.activatePoll();

</script>

<!-- Component View -->
<!-- BEGIN BENCHMARK RUN CONFIG  -->
<div class='row'>
    <div class='col-lg-12' >
        <div class="col-md-4">
            <br><h1> Stress Tools </h1>
        </div>
        <!-- BEGIN RUN CONFIG FORM -->
        <form onsubmit="getBenchmarkAction(this);" target='dummyframe'>
            <div class= 'form-group'>
                <div class="col-md-3">
                    Tool Type
                    <script>
                        document.getElementById('benchmark-container').value = run_detail['id'];
                    </script>
                    <!-- Dynamically populate benchmark dropdown and restore last user-select benchmark -->
                    <select id='benchmark-container'  class="selectpicker form-control" >
                          {% for benchmark in benchmarks %}
                          <option value="{{ benchmark['id'] }}">{{ benchmark['name'] }}</option>
                          {% endfor %}
                    </select>
                </div>
                <div class='col-md-3'>
                    {% include 'templates/components/config-editor.html' %}
                </div>

                <!-- Toggle Between Start/Stop Button -->
                <div class="col-md-1">
                    {% if run_detail['progress'] == 0 or run_detail['progress'] == 100 -%}
                    <input id='benchmark-start-stop' type="submit" style='width: 100%' class="btn btn-info btn-lg" value='Start'></input>
                    {% else -%}
                    <input id='benchmark-start-stop' type="submit" style='width: 100%' class="btn btn-warning btn-lg" value='Stop'></input>
                    {%- endif %}
                </div>
            </div>
        </form>
    </div>

</div>


<br><br>
<!-- END BENCHMARK RUN CONFIG -->
